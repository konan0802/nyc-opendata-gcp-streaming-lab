# 実装計画

このドキュメントは、NYC OpenData GCP ストリーミングETLシステムの実装手順、コスト見積もり、運用計画を記載します。

設計の詳細については [DESIGN.md](./DESIGN.md) を参照してください。

## 1. 実装ステップ

### Phase 1: 基本パイプライン構築（MVP）

#### 1.1 環境セットアップ
- [ ] GCPプロジェクト作成
- [ ] 必要なAPIの有効化
  - Cloud Functions API
  - Cloud Scheduler API
  - Pub/Sub API
  - BigQuery API
  - Secret Manager API
- [ ] サービスアカウント作成
- [ ] ローカル開発環境構築
  - Python 3.11+
  - gcloud CLI
  - Terraform

#### 1.2 Terraformセットアップ
- [ ] Terraformディレクトリ構成作成
- [ ] バックエンド設定（GCS）
- [ ] 変数定義ファイル作成
- [ ] モジュール構成設計

#### 1.3 BigQueryセットアップ（Terraform）
- [ ] データセット作成
- [ ] テーブルスキーマ定義
- [ ] パーティショニング・クラスタリング設定
- [ ] エラーログテーブル作成

#### 1.4 Pub/Sub構築（Terraform）
- [ ] トピック作成（`nyc-opendata-raw`）
- [ ] BigQuery Subscriptionの作成
- [ ] Dead Letter Topic設定
- [ ] IAMロール設定

#### 1.5 Data Fetcher実装
- [ ] Cloud Function実装（Python 3.11+）
  - [ ] NYC Open Data API統合（Socrata SODA API）
  - [ ] 増分取得ロジック実装（`$where` クエリ）
  - [ ] 状態管理（Cloud Storage）
  - [ ] BigQueryスキーマに合わせたJSON整形
  - [ ] Pub/Subパブリッシュ機能
  - [ ] エラーハンドリングとリトライロジック
  - [ ] 構造化ロギング設定
- [ ] ローカルでのユニットテスト
- [ ] Secret Manager統合（APIトークン）

#### 1.6 Cloud Functionデプロイ（Terraform）
- [ ] Cloud Function リソース定義
- [ ] 環境変数設定
- [ ] IAMロール設定

#### 1.7 スケジューラー設定（Terraform）
- [ ] Cloud Scheduler作成
- [ ] 実行間隔設定（5分毎）
- [ ] タイムゾーン設定（America/New_York）

#### 1.8 動作確認
- [ ] 手動トリガーテスト
- [ ] エンドツーエンドテスト
- [ ] データフロー確認
- [ ] エラーケーステスト
  - API障害時の挙動
  - スキーマミスマッチの処理
  - リトライロジックの確認

### Phase 2: 監視・運用機能追加

#### 2.1 モニタリング設定（Terraform）
- [ ] Cloud Monitoring ダッシュボード作成
  - データ取得レート
  - エラー率
  - 処理レイテンシ
  - BigQuery挿入レコード数
- [ ] アラート設定
  - データ取得失敗3回連続
  - 処理遅延10分以上
  - エラー率5%以上
  - BigQuery挿入失敗
- [ ] 通知チャネル設定（Email/Slack）

#### 2.2 ログ集約
- [ ] Cloud Logging ログシンク設定
- [ ] BigQueryへのログエクスポート
- [ ] ログベースメトリクス作成

#### 2.3 テスト強化
- [ ] ユニットテスト拡充
- [ ] インテグレーションテスト
- [ ] 負荷テスト（大量データ）

#### 2.4 ドキュメント整備
- [ ] 運用手順書
- [ ] トラブルシューティングガイド
- [ ] アラート対応手順

### Phase 3: 高度な機能（オプション）

#### 3.1 最適化
- [ ] パフォーマンスチューニング
  - バッチサイズ最適化
  - 並列処理の検討
- [ ] コスト最適化
  - BigQueryクエリ最適化
  - 不要なログの削減
- [ ] Dataflow移行検討（必要に応じて）

#### 3.2 追加機能
- [ ] データ品質チェック
  - スキーマバリデーション
  - 値の範囲チェック
  - null値の検証
- [ ] データリネージ追跡
- [ ] 複数データソース対応
- [ ] リアルタイムダッシュボード（Looker Studio）

## 2. コスト見積もり

### 想定条件
- データ取得頻度: 5分毎（月間8,640回）
- 1回あたりのデータ量: 100レコード
- 月間総レコード数: 約86万レコード
- レコードサイズ: 平均2KB

### サービス別コスト（月間）

| サービス | 使用量 | 概算コスト (USD) |
|---------|--------|-----------------|
| Cloud Scheduler | 1ジョブ | $0.10 |
| Cloud Functions | 8,640呼び出し、各30秒 | $0.50 |
| Pub/Sub | 1.7GB転送、ストレージ | $0.60 |
| BigQuery Storage | 2GB（圧縮後） | $0.04 |
| BigQuery Streaming | 86万レコード（BigQuery Sub経由） | $0.50 |
| Cloud Storage | 状態管理ファイル | $0.01 |
| Cloud Logging | 5GB | $0.25 |
| Secret Manager | APIトークン1個 | $0.01 |
| **合計** | | **約$2/月** |

**コスト削減ポイント**:
- ETL処理層なしで非常に低コスト
- BigQuery Subscriptionで追加の処理コスト不要
- Dataflowは不使用（使用する場合+$50-100/月）

### コストアラート設定
- 月額$5を超えた場合にアラート
- 日次コストレポート

## 3. 運用計画

### 3.1 モニタリング指標（KPI）

| 指標 | 目標値 | アラート閾値 |
|------|--------|-------------|
| データ鮮度 | 5分以内 | 10分以上 |
| エラー率 | < 1% | > 5% |
| 処理レイテンシ | < 30秒 | > 60秒 |
| 可用性 | > 99.5% | < 99% |
| 月間コスト | $2前後 | > $5 |

### 3.2 定期メンテナンス

**日次**:
- [ ] エラーログ確認
- [ ] データ取得状況確認

**週次**:
- [ ] パフォーマンスレビュー
- [ ] コストレビュー
- [ ] Dead Letter Topicのメッセージ確認

**月次**:
- [ ] BigQueryテーブルサイズ確認
- [ ] 古いデータのアーカイブ検討
- [ ] セキュリティパッチ適用

### 3.3 バックアップ・リカバリ

**状態管理**:
- Cloud Storageに最終取得時刻を保存
- バージョニング有効化

**データバックアップ**:
- BigQueryスナップショット（週次）
- 保持期間: 30日

**リカバリ手順**:
1. Dead Letter Topicからメッセージ再発行
2. 手動でCloud Functionをトリガー
3. BigQueryで重複データをMERGE処理

### 3.4 スケーリング戦略

**現在の設計での限界**:
- Cloud Functions: 最大9分のタイムアウト
- Pub/Sub: 1メッセージあたり10MB
- BigQuery Streaming: 100,000 rows/秒（十分）

**スケーリングが必要になる場合**:
- データ量が10倍以上増加 → Cloud Runへ移行
- 複雑な変換が必要 → Dataflowへ移行
- リアルタイム性が重要 → Pub/Subのパーティション数増加

## 4. 将来の検討事項

### 4.1 機能拡張
- [ ] 複数のNYC Open Dataソースへの対応
- [ ] リアルタイムダッシュボード構築（Looker Studio等）
- [ ] 機械学習モデルとの統合
- [ ] データ品質スコアリング
- [ ] アノマリ検知

### 4.2 技術的改善
- [ ] CI/CD パイプライン構築
  - Cloud Build
  - GitHub Actions
- [ ] Terraform完全対応
  - すべてのリソースをコード化
  - 環境分離（dev/prod）
- [ ] マルチリージョン対応
- [ ] ディザスタリカバリ計画

### 4.3 データガバナンス
- [ ] データカタログ整備（Data Catalog）
- [ ] データリネージ管理
- [ ] データ保持ポリシー策定
  - 個人情報の保持期間
  - アーカイブルール
- [ ] コンプライアンス対応（GDPR等）

### 4.4 開発効率向上
- [ ] ローカル開発環境の改善
  - Pub/Sub Emulator
  - BigQuery Emulator
- [ ] テスト自動化
- [ ] ドキュメント自動生成

---

**最終更新**: 2025-12-07

